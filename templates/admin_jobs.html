<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Job Listings - University Job Fair</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="header">
        <div class="nav-container">
            <h1>Admin - Job Listings</h1>
            <div class="nav-links">
                <button class="nav-toggle" onclick="toggleNavigation()">☰ Menu</button>
                <span>Welcome, {{ session.full_name }}!</span>
                <a href="{{ url_for('logout') }}" class="logout-btn">Logout</a>
            </div>
        </div>
        
        <!-- Navigation Tabs -->
        <div class="navigation-tabs" id="navigationTabs">
            <div class="tab-container">
                <a href="{{ url_for('admin_dashboard') }}" class="nav-tab">
                    <span class="tab-text">Applicants</span>
                </a>
                <a href="{{ url_for('admin_jobs') }}" class="nav-tab active">
                    <span class="tab-text">Job Listings</span>
                </a>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Flash messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="flash-messages">
                    {% for category, message in messages %}
                        <div class="flash-message flash-{{ category }}">
                            <span class="flash-text">{{ message }}</span>
                            <button class="flash-dismiss" onclick="dismissFlash(this)">&times;</button>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <div class="dashboard-content">
            <div class="jobs-header">
                <h2>All Job Listings</h2>
                
                <div class="jobs-controls">
                    <div class="stats">
                        <div class="stat-card">
                            <h3>Total Jobs</h3>
                            <p class="stat-number">{{ jobs|length }}</p>
                        </div>
                        <div class="stat-card">
                            <h3>Open Jobs</h3>
                            <p class="stat-number">{{ jobs|selectattr('is_open')|list|length }}</p>
                        </div>
                    </div>
                    
                    <div class="sort-controls">
                        <label for="sortBy">Sort by:</label>
                        <select id="sortBy" onchange="sortJobs()">
                            <option value="title">Position Name</option>
                            <option value="company">Company Name</option>
                            <option value="deadline">Application Deadline</option>
                            <option value="applications">Application Count</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="jobs-list" id="jobsList">
                {% for job in jobs %}
                <div class="job-item {% if not job.is_open %}job-closed{% endif %}" onclick="viewJobDetail({{ job.id }})">
                    <div class="job-info">
                        <h3 class="job-title">{{ job.title }}</h3>
                        <p class="job-company">{{ job.company_name or job.company }}</p>
                        <div class="job-details">
                            <span class="application-count">{{ job.application_count }} applicant{{ 's' if job.application_count != 1 else '' }}</span>
                            <span class="application-deadline">Deadline: {{ job.application_deadline }}</span>
                            {% if not job.is_open %}
                            <span class="job-status-closed">CLOSED</span>
                            {% else %}
                            <span class="job-status-open">OPEN</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="job-actions">
                        <span class="view-detail">View Details →</span>
                    </div>
                </div>
                {% endfor %}
                
                {% if not jobs %}
                <div class="no-data">
                    <p>No job listings available.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <script>
        // Store jobs data for sorting
        const jobsData = {{ jobs|tojson }};

        function viewJobDetail(jobId) {
            window.location.href = `/job/${jobId}`;
        }

        function sortJobs() {
            const sortBy = document.getElementById('sortBy').value;
            const jobsList = document.getElementById('jobsList');
            
            // Sort the jobs data
            let sortedJobs = [...jobsData];
            
            switch(sortBy) {
                case 'title':
                    sortedJobs.sort((a, b) => a.title.localeCompare(b.title));
                    break;
                case 'company':
                    sortedJobs.sort((a, b) => (a.company_name || a.company).localeCompare(b.company_name || b.company));
                    break;
                case 'deadline':
                    sortedJobs.sort((a, b) => new Date(a.application_deadline) - new Date(b.application_deadline));
                    break;
                case 'applications':
                    sortedJobs.sort((a, b) => b.application_count - a.application_count);
                    break;
            }
            
            // Re-render the jobs list
            renderJobsList(sortedJobs);
        }

        function renderJobsList(jobs) {
            const jobsList = document.getElementById('jobsList');
            
            if (jobs.length === 0) {
                jobsList.innerHTML = '<div class="no-data"><p>No job listings available.</p></div>';
                return;
            }
            
            jobsList.innerHTML = jobs.map(job => `
                <div class="job-item ${!job.is_open ? 'job-closed' : ''}" onclick="viewJobDetail(${job.id})">
                    <div class="job-info">
                        <h3 class="job-title">${job.title}</h3>
                        <p class="job-company">${job.company_name || job.company}</p>
                        <div class="job-details">
                            <span class="application-count">${job.application_count} applicant${job.application_count !== 1 ? 's' : ''}</span>
                            <span class="application-deadline">Deadline: ${job.application_deadline}</span>
                            ${!job.is_open ? '<span class="job-status-closed">CLOSED</span>' : '<span class="job-status-open">OPEN</span>'}
                        </div>
                    </div>
                    <div class="job-actions">
                        <span class="view-detail">View Details →</span>
                    </div>
                </div>
            `).join('');
        }

        function dismissFlash(button) {
            const flashMessage = button.parentElement;
            flashMessage.style.opacity = '0';
            flashMessage.style.transform = 'translateX(100%)';
            setTimeout(() => {
                flashMessage.remove();
                // Remove the entire flash-messages container if no messages left
                const flashContainer = document.querySelector('.flash-messages');
                if (flashContainer && flashContainer.children.length === 0) {
                    flashContainer.remove();
                }
            }, 300);
        }

        // Auto-dismiss flash messages after 5 seconds
        document.addEventListener('DOMContentLoaded', function() {
            const flashMessages = document.querySelectorAll('.flash-message');
            flashMessages.forEach(message => {
                setTimeout(() => {
                    const dismissBtn = message.querySelector('.flash-dismiss');
                    if (dismissBtn && message.parentElement) {
                        dismissFlash(dismissBtn);
                    }
                }, 5000);
            });
        });

        function toggleNavigation() {
            const navTabs = document.getElementById('navigationTabs');
            navTabs.classList.toggle('show');
        }

        // Close navigation when clicking outside
        document.addEventListener('click', function(event) {
            const navTabs = document.getElementById('navigationTabs');
            const navToggle = document.querySelector('.nav-toggle');
            
            if (!navTabs.contains(event.target) && !navToggle.contains(event.target)) {
                navTabs.classList.remove('show');
            }
        });
    </script>
</body>
</html>